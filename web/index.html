<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Environmental Dashboard</title>

    <script type="module" src="./index.js" defer></script>

    <style>
        :root{
            --bg:#f7f9fb;
            --card:#ffffff;
            --muted:#6b7280;
            --accent:#3b82f6;
            --accent-2:#fb923c;
            --shadow: 0 8px 24px rgba(15,23,42,0.06);
            --radius:12px;
            --gap:12px;
            --glass-border: rgba(15,23,42,0.04);
            --text:#0f1724;
        }

        html,body{
            height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
            background: linear-gradient(180deg, #f8fbff 0%, #f2f6fa 100%);
            color:var(--text);-webkit-font-smoothing:antialiased;
        }

        /* App layout */
        .app {
            display:flex;
            flex-direction:column;
            min-height:100vh;
            gap:var(--gap);
        }

        header.appbar {
            display:flex;
            gap:var(--gap);
            align-items:center;
            padding:18px;
            background: var(--card);
            box-shadow: var(--shadow);
            border-radius: calc(var(--radius));
            margin: 18px;
            top: 12px;
            z-index: 50;
        }

        .brand {
            display:flex;
            gap:12px;
            align-items:center;
            min-width:180px;
        }
        .logo {
            width:64px;height:46px;border-radius:10px;
            background:linear-gradient(135deg,var(--accent),#6d28d9);
            display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:16px;box-shadow:0 8px 20px rgba(59,130,246,0.12);
        }
        .title { font-size:1.05rem;font-weight:700; }
        .subtitle { font-size:0.8rem;color:var(--muted); }

        .controls {
            margin-left:auto;display:flex;gap:12px;align-items:center;flex-wrap:wrap;
        }

        .control {
            background:var(--card);
            border:1px solid var(--glass-border);
            padding:8px 10px;border-radius:10px;
            display:flex;flex-direction:column;gap:4px;min-width:110px;
            box-shadow: 0 6px 14px rgba(15,23,42,0.04);
        }
        .control.inline {
            flex-direction:row;align-items:center;gap:8px;padding:8px 12px;
        }

        label.small { font-size:0.75rem;color:var(--muted); }
        select,input[type="number"], input[type="text"] {
            border:0;background:transparent;outline:none;font-size:0.95rem;color:var(--text);
            width:100%;
        }

        .btn {
            padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:600;
            height:46px; /* match inputs */
            display:inline-flex;align-items:center;justify-content:center;
            box-shadow: 0 4px 10px rgba(2,6,23,0.06);
        }
        .btn.primary {
            background:var(--accent);color:white;box-shadow:0 8px 18px rgba(59,130,246,0.14);
        }
        .btn.ghost {
            background:transparent;border:1px solid var(--glass-border);color:var(--text);
        }

        /* Main content */
        main.container {
            padding: 8px 18px 36px;
            display:flex;
            gap:18px;
            flex-direction:column;
        }

        .chart-card {
            padding:16px;border-radius:var(--radius);box-shadow:var(--shadow);
            background: var(--card);
        }

        .toolbar {
            display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:8px;
        }

        .meta-line { color:var(--muted); font-size:0.9rem; display:flex;gap:12px;align-items:center;flex-wrap:wrap; }

        /* Chart wrapper (fixes Chart.js resize loop) */
        .chart-container {
            position: relative;
            width: 100%;
            height: 68vh;        /* desired chart height */
            max-height: 88vh;
        }
        canvas#chart {
            width: 100% !important;
            height: 100% !important;
            display: block;
        }

        /* Modal for sensors */
        .modal-backdrop {
            position:fixed;inset:0;background:rgba(12,20,30,0.35);display:none;align-items:center;justify-content:center;z-index:60;
        }
        .modal {
            width:min(980px,94vw);max-height:78vh;overflow:auto;background:var(--card);border-radius:14px;padding:16px;box-shadow:0 14px 40px rgba(2,6,23,0.12);
            display:flex;flex-direction:column;gap:12px;
        }
        .modal-head { display:flex;justify-content:space-between;align-items:center;gap:12px; }
        .search {
            width:100%;padding:10px;border-radius:10px;border:1px solid var(--glass-border);background:#fff;color:var(--text);
            font-size:0.95rem;
        }
        .tag-cloud { display:flex;gap:8px;flex-wrap:wrap;padding:8px 4px; }
        .tag {
            padding:8px 10px;border-radius:999px;background:#f3f6fb;color:var(--text);
            border:1px solid rgba(15,23,42,0.04);cursor:pointer;font-size:0.9rem;
        }
        .tag.selected { background: linear-gradient(90deg,var(--accent-2),#ff7b57); color:white; box-shadow: 0 6px 20px rgba(251,146,60,0.12); transform:translateY(-2px); }

        /* Loading overlay */
        #loading-overlay {
            position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0;transition:0.15s;z-index:70;
        }
        .loading-box {
            background:rgba(255,255,255,0.95);padding:14px;border-radius:10px;box-shadow:0 8px 30px rgba(2,6,23,0.08);
        }

        @media (max-width:900px) {
            header.appbar { margin: 12px; padding:14px; }
            .controls { width:100%; justify-content:flex-end; }
            .control { min-width:72px; }
            .chart-container { height:62vh; }
            .brand {display: none; }
        }
    </style>
</head>
<body>
<div class="app">
    <header class="appbar" role="banner" aria-label="Top controls">
        <div class="brand" aria-hidden="true">
            <div class="logo">ENV</div>
            <div>
                <div class="title">Environmental Dashboard</div>
                <div class="subtitle">Fast aggregated charts — choose sensors and period</div>
            </div>
        </div>

        <div class="controls" role="region" aria-label="Chart controls">
            <div class="control" style="min-width:120px">
                <label class="small" for="period">Period</label>
                <select id="period" aria-label="Period selector"></select>
            </div>

            <div class="control" style="min-width:120px">
                <label class="small" for="length">Points</label>
                <input id="length" type="number" min="10" max="5000" value="300" />
            </div>

            <div class="control" style="min-width:110px">
                <label class="small" for="ratio">Ratio</label>
                <input id="ratio" type="number" min="0.1" max="1" step="0.1" value="1" />
            </div>

            <div class="control" style="min-width:180px">
                <label class="small" for="min">Min</label>
                <input id="min" type="text" placeholder="e.g. 0,100" />
            </div>

            <div class="control" style="min-width:180px">
                <label class="small" for="max">Max</label>
                <input id="max" type="text" placeholder="e.g. 200,1000" />
            </div>

            <!-- standalone buttons -->
            <button id="sensors-btn" class="btn ghost" aria-haspopup="dialog" title="Open sensor selector">Sensors</button>
            <button id="update" class="btn primary" title="Refresh chart">Update</button>
        </div>
    </header>

    <main class="container">
        <section class="chart-card" aria-label="Chart area">
            <div class="toolbar">
                <div>
                    <h3 id="chart-title" style="margin:0">Chart</h3>
                    <div class="meta-line" id="meta-line"> </div>
                </div>

                <div style="display:flex;gap:8px;align-items:center">
                    <button id="download" class="btn ghost" title="Get CSV">Get CSV</button>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="chart" aria-label="Main chart"></canvas>
            </div>
        </section>
    </main>
</div>

<!-- Sensor selection modal (used by bundle/index.js) -->
<div id="modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
        <div class="modal-head">
            <div>
                <h3 style="margin:0">Select sensors</h3>
                <div style="color:var(--muted);font-size:0.9rem">Pick sensors to display. Click to toggle or use Select All / Clear.</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
                <button id="modal-select-all" class="btn ghost">Select All</button>
                <button id="modal-clear" class="btn ghost">Clear</button>
                <button id="modal-close" class="btn primary">Done</button>
            </div>
        </div>

        <input id="modal-search" class="search" placeholder="Search sensors..." aria-label="Search sensors" />
        <div id="modal-tag-cloud" class="tag-cloud" aria-live="polite"></div>
    </div>
</div>

<!-- Loading overlay -->
<div id="loading-overlay" style="pointer-events:none;opacity:0;transition:0.15s">
    <div class="loading-box">
        <div style="display:flex;gap:12px;align-items:center;color:var(--text)">
            <div style="width:36px;height:36px;border-radius:50%;border:4px solid rgba(59,130,246,0.18);border-left-color:var(--accent);animation:spin 1s linear infinite"></div>
            <div id="loading-text" style="min-width:120px">Loading…</div>
        </div>
    </div>
</div>

<style>@keyframes spin { to { transform: rotate(360deg); } }</style>

<script>
    // Provide light helper hooks consumed by module if desired
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    function showLoading(text='Loading…') {
        loadingText.textContent = text;
        loadingOverlay.style.pointerEvents = 'auto';
        loadingOverlay.style.opacity = '1';
    }
    function hideLoading() {
        loadingOverlay.style.pointerEvents = 'none';
        loadingOverlay.style.opacity = '0';
    }
    window.__ui = { showLoading, hideLoading };
</script>
</body>
</html>
